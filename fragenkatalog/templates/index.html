{% extends "base.html" %}
{% load i18n %}
{% load staticfiles %}
{% load highlight %}

{% block body %}

<div class="container" style="padding-top: 20px;">


    {% for quiz in quizzes %}
    {% if forloop.first %}<div class="card-group">{% endif %}
    <div class="card border-dark mb-3 hoverable shadow-lg" style="max-width: 18rem;">

    {% if quiz.image %}
    <img class="card-img-top card-header" style="padding: 0;" src="{{ quiz.image.url }}"
         style="max-height: 30rem; object-fit: contain;">
    {% else %}
    <div class="card-header text-center text-light bg-primary">
      <span class="fas fa-question-circle" style="font-size: 100px;"></span>
    </div>
    {% endif %}
    <div class="card-body text-dark">
      <h5 class="card-title">
          {% if search %}
          {{ quiz.title|highlight:search }}
          {% else %}
          {{ quiz.title }}
          {% endif %}
          <small class="text-black-50">(Quiz)</small>
      </h5>
      <p class="card-text">
          {% if search %}
          {{ quiz.description|highlight:search }}
          {% else %}
          {{ quiz.description }}
          {% endif %}
      </p>
    {% if quiz.textualquestion_set.count > 0 %}
        <span class="card-text badge badge-secondary">
          {{ quiz.textualquestion_set.count }} question{{ quiz.textualquestion_set.count|pluralize:"s" }}
        </span>
    {% endif %}
    {% for hashtag in quiz.hashtag_set %}
        <span class="card-text badge badge-secondary">
          {% if search %}
          {{ hashtag|highlight:search }}
          {% else %}
          {{ hashtag }}
          {% endif %}
        </span>
    {% endfor %}
      <p class="card-text">
        <small class="text-muted">
          {% blocktrans with time=quiz.pubdate|timesince %}
          Published {{ time }} ago.
          {% endblocktrans %}
        </small>
      </p>
      {% if quiz.textualquestion_set.count > 0 %}
        <a class="btn btn-outline-primary" href="{% url 'questionnaire' quiz.id %}">
            Show
        </a>
      {% else %}
        <button class="btn btn-outline-secondary" disabled>Coming soon</button>
      {% endif %}
        {% if user in quiz.likers %}
        <button class="btn btn-outline-secondary" disabled>
            <span class="fas fa-thumbs-up"></span> {{ quiz.likes.count }}
        </button>
        {% else %}
        <button id="like-quiz-{{ quiz.id }}"
                class="btn btn-outline-dark"
                {% if not user.is_authenticated %} disabled {% endif %}
                onclick="likeQuiz({{ quiz.id }}, '#like-quiz-{{ quiz.id }}', {{ quiz.likes.count }})">
            <span class="far fa-thumbs-up"></span> {{ quiz.likes.count }}
        </button>
        {% endif %}
    </div>
    </div>
    {% if forloop.counter|divisibleby:4 %}</div><div class="card-group">{% endif %}
    {% if forloop.last %}</div>{% endif %}
    {% endfor %}
</div>

{% if compilations %}

<div class="container" style="padding-top: 20px; background-color: #f8f8f8; border-radius: 8px; margin-top: 20px;">

    {% for compilation in compilations %}
    {% if forloop.first %}<div class="card-group">{% endif %}
    <div class="card border-dark mb-3 hoverable shadow-lg" style="max-width: 18rem;">

    {% if compilation.image %}
    <img class="card-img-top card-header" style="padding: 0;" src="{{ compilation.image.url }}"
         style="max-height: 30rem; object-fit: contain;">
    {% else %}
    <div class="card-header text-center text-light bg-primary">
      <span class="fas fa-layer-group" style="font-size: 100px;"></span>
    </div>
    {% endif %}
    <div class="card-body text-dark">
      <h5 class="card-title">
          {% if search %}
          {{ compilation.title|highlight:search }}
          {% else %}
          {{ compilation.title }}
          {% endif %}
          <small class="text-black-50">(Compilation)</small>
      </h5>
      <p class="card-text">
          {% if search %}
          {{ compilation.description|highlight:search }}
          {% else %}
          {{ compilation.description }}
          {% endif %}
      </p>
    {% if compilation.quiz_set.count > 0 %}
        <span class="card-text badge badge-secondary">
          {{ compilation.quiz_set.count }} quiz{{ compilation.quiz_set.count|pluralize:"zes" }}
        </span>
    {% endif %}
      <p class="card-text">
        <small class="text-muted">
          {% blocktrans with time=compilation.pubdate|timesince %}
          Published {{ time }} ago.
          {% endblocktrans %}
        </small>
      </p>
      {% if compilation.quiz_set.count > 0 %}
        <a class="btn btn-outline-primary" href="{% url 'compilation' compilation.id %}">
            Show
        </a>
      {% else %}
        <button class="btn btn-outline-secondary" disabled>Coming soon</button>
      {% endif %}
      {% if user in compilation.likers %}
        <button class="btn btn-outline-secondary" disabled>
            <span class="fas fa-thumbs-up"></span> {{ compilation.likes.count }}
        </button>
        {% else %}
        <button id="like-compilation-{{ compilation.id }}"
                class="btn btn-outline-dark"
                {% if not user.is_authenticated %} disabled {% endif %}
                onclick="likeCompilation({{ compilation.id }}, '#like-compilation-{{ compilation.id }}', {{ compilation.likes.count }})">
            <span class="far fa-thumbs-up"></span> {{ compilation.likes.count }}
        </button>
      {% endif %}
    </div>
    </div>
    {% if forloop.counter|divisibleby:4 %}</div><div class="card-group">{% endif %}
    {% if forloop.last %}</div>{% endif %}
    {% endfor %}

</div>

{% endif %}

{% endblock %}

{% block extrabody %}
{% if user.is_authenticated and user.is_superuser %}
<script>
$(".confirmation-needed").click(function(e) {
    if (!confirm("Do you really want to do this?")) {
        e.preventDefault();
    }
});
</script>
{% endif %}

{% if user.is_authenticated %}
<script>
function likeQuiz(quizId, elemId, numberOfLikes) {
    var data = {};
    data["quiz_id"] = quizId;
    $.ajax({
        url: "{% url 'like_quiz' %}",
        type: "post",
        data: data,
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        datatype: "json",
        success: function(response) {
            if (response.success === true) {
                $(elemId).html(
                    '<span class="fas fa-thumbs-up"></span> ' + (numberOfLikes + 1)
                );
            }
        }
    });
}

function likeCompilation(compilationId, elemId, numberOfLikes) {
    var data = {};
    data["compilation_id"] = compilationId;
    $.ajax({
        url: "{% url 'like_compilation' %}",
        type: "post",
        data: data,
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        datatype: "json",
        success: function(response) {
            if (response.success === true) {
                $(elemId).html(
                    '<span class="fas fa-thumbs-up"></span> ' + (numberOfLikes + 1)
                );
            }
        }
    });
}
</script>
{% endif %}
{% endblock %}